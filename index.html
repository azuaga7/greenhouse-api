<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADTEC 췅 Invernadero Pro Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lucide@0.263.1/dist/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        
    :root { 
        --accent: #38bdf8; --bg: #020617; --surface: rgba(15, 23, 42, 0.8); 
        --border: rgba(148, 163, 184, 0.2); --success: #22c55e; --warn: #eab308; --danger: #ef4444;
        --text: #f8fafc; --text-muted: #94a3b8;
        --adtec-accent: #38bdf8;
    }
    
    * { box-sizing: border-box; }
    body { 
        margin: 0; background: var(--bg); color: var(--text); 
        font-family: 'Inter', system-ui, -apple-system, sans-serif; min-height: 100vh;
        display: flex; flex-direction: column; align-items: center; padding: 20px;
        background-image: radial-gradient(circle at top, #0f172a 0%, #020617 100%);
        overflow-x: hidden;
    }

    .dashboard-container {
        position: relative;
        background: rgba(15, 23, 42, 0.4);
        border: 1px solid var(--border);
        border-radius: 16px;
        box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(12px);
        overflow: hidden;
        margin-top: 20px;
    }

    .widgets-canvas { position: relative; width: 100%; height: 100%; }
    .grid-overlay {
        position: absolute; inset: 0;
        background-image: radial-gradient(rgba(56, 189, 248, 0.03) 1px, transparent 1px);
        background-size: 20px 20px; pointer-events: none;
    }

    .tabs-nav { display: flex; gap: 8px; margin-bottom: 10px; overflow-x: auto; padding: 10px; width: 100%; max-width: 1000px; justify-content: center; }
    .tab-btn { 
        padding: 10px 20px; cursor: pointer; border-radius: 10px; font-size: 12px; font-weight: 700;
        transition: all 0.2s; color: var(--text-muted); border: 1px solid transparent;
        display: flex; align-items: center; gap: 10px; white-space: nowrap; text-transform: uppercase;
    }
    .tab-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }
    .tab-btn.active { background: rgba(56, 189, 248, 0.1); border-color: rgba(56, 189, 248, 0.2); color: var(--accent); }

    .widget {
        position: absolute;
        background: rgba(30, 41, 59, 0.5);
        border: 1px solid var(--border);
        border-radius: 12px;
        padding: 12px;
        display: flex; flex-direction: column;
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
    }
    .widget:hover {
        border-color: var(--accent);
        box-shadow: 0 0 15px rgba(56, 189, 248, 0.15);
    }
    .widget-label { 
        font-size: 10px; 
        text-transform: uppercase; 
        color: #94a3b8; 
        margin: 0 0 8px 0; 
        font-weight: 700; 
        letter-spacing: 0.05em; 
    }
    .widget-value { font-size: 22px; font-weight: 700; color: #f8fafc; margin: 2px 0; }
    .widget-unit { font-size: 12px; color: #94a3b8; margin-left: 4px; }
    
    .gauge-bar { width: 100%; height: 6px; background: rgba(15,23,42,0.8); border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 4px; margin-top: 5px; overflow: hidden; position: relative; }
    .gauge-fill { height: 100%; width: 0%; transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); background: var(--accent); box-shadow: 0 0 10px rgba(56, 189, 248, 0.4); }

    .status-chip { display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; border-radius: 999px; font-size: 10px; font-weight: 700; margin-top: auto; text-transform: uppercase; border: 1px solid rgba(148, 163, 184, 0.3); letter-spacing: 0.5px; }
    .status-chip.on { background: rgba(34,197,94,0.1); color: #22c55e; border-color: rgba(34,197,94,0.4); }
    .status-chip.off { background: rgba(239,68,68,0.1); color: #ef4444; border-color: rgba(239,68,68,0.4); }
    .status-dot { width: 7px; height: 7px; border-radius: 50%; background: currentColor; box-shadow: 0 0 10px currentColor; }

    .control-btn { 
        flex: 1; padding: 10px; border-radius: 8px; border: 1px solid rgba(148,163,184,0.1); 
        color: white; font-weight: 800; font-size: 11px; cursor: pointer; 
        transition: all 0.2s; background: rgba(255,255,255,0.05); 
    }
    .control-btn:hover { background: rgba(255,255,255,0.1); }

    input[type="range"] {
        -webkit-appearance: none; width: 100%; height: 4px; background: #334155; border-radius: 2px; outline: none;
    }
    input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none; width: 14px; height: 14px; background: var(--accent); border-radius: 50%; cursor: pointer;
    }

    .adtec-label-widget {
        pointer-events: none;
        white-space: nowrap;
        font-family: 'Inter', sans-serif;
        letter-spacing: -0.02em;
    }

    .gsm-bars { display: flex; gap: 2px; align-items: flex-end; height: 14px; }
    .gsm-bar { width: 3px; background: rgba(255,255,255,0.1); border-radius: 1px; }
    .gsm-bar.active { background: var(--accent); box-shadow: 0 0 5px var(--accent); }

    </style>
</head>
<body style="margin:0; padding:0; background:#020617; color:#f8fafc; font-family:'Inter', sans-serif;">
    <div id="dashboard-root"></div>
    <script>
        // Configuraci칩n Maestra exportada desde el Studio
        const CONFIG = {
            dashboard: {"tabs":[{"id":"1","name":"Estado Actual","icon":"游늯","title":"Estado Actual del Invernadero","width":970,"height":900,"type":"dashboard"},{"id":"2","name":"Grafico","icon":"游늯","title":"Laboratorio de Gr치ficos","width":1000,"height":700,"type":"charts"},{"id":"3","name":"Control","icon":"游늯","title":"Control Remoto de Invernadero","width":700,"height":800,"type":"control"}],"widgets":[{"id":"w_1768270825285","type":"gauge","label":"Humedad del Invernadero","key":"dht22_1_HUM_OUT","unit":"%","min":0,"max":100,"x":240,"y":10,"w":220,"h":180,"tabId":"1","format":"fixed1"},{"id":"w_1768270831388","type":"gauge","label":"Temperatura del Invernadero","key":"dht22_1_TEMP_OUT","unit":"춿C","min":0,"max":100,"x":10,"y":10,"w":220,"h":180,"tabId":"1","format":"fixed1"},{"id":"w_1768270903173","type":"gauge","label":"Temperatura Exterior","key":"ds18b20_2_TEMP_OUT","unit":"춿C","min":0,"max":100,"x":10,"y":210,"w":220,"h":180,"tabId":"1","format":"fixed1"},{"id":"w_1768270908326","type":"gauge","label":"Temperatura de Pozo","key":"ds18b20_1_TEMP_OUT","unit":"춿C","min":0,"max":100,"x":240,"y":210,"w":220,"h":180,"tabId":"1","format":"fixed1"},{"id":"w_1768270938829","type":"gauge","label":"Frecuencia Ventiladores Pared","key":"vfd_1_FREQ_OUT","unit":"Hz","min":0,"max":100,"x":10,"y":410,"w":220,"h":180,"tabId":"1","format":"fixed1","inverted":false},{"id":"w_1768270972142","type":"gauge","label":"Luxes","key":"tsl2561_1_LUX_OUT","unit":"LX","min":0,"max":120000,"x":240,"y":410,"w":220,"h":180,"tabId":"1","format":"fixed1"},{"id":"w_1768270996596","type":"indicator","label":"Estado Bomba de Agua","key":"relay_3_STATE_OUT","min":0,"max":100,"x":500,"y":120,"w":180,"h":80,"tabId":"1","format":"bool_onoff"},{"id":"w_1768271000492","type":"location","label":"Ubicaci칩n","key":"sin_key","min":0,"max":100,"x":700,"y":610,"w":200,"h":85,"tabId":"1","format":"fixed1"},{"id":"w_1768271000964","type":"datetime","label":"Reloj Sistema","key":"timestamp","min":0,"max":100,"x":480,"y":10,"w":220,"h":85,"tabId":"1","format":"raw"},{"id":"w_1768271001285","type":"connection","label":"Estado Red","key":"gsm_signal","min":0,"max":100,"x":720,"y":10,"w":180,"h":85,"tabId":"1","format":"raw"},{"id":"w_1768271019292","type":"indicator","label":"Estado de Ventiladores Axiales","key":"vfd_1_STATE_OUT","min":0,"max":100,"x":500,"y":450,"w":180,"h":80,"tabId":"1","format":"bool_onoff"},{"id":"w_1768271019940","type":"indicator","label":"Estado Vent. 2","key":"relay_2_STATE_OUT","min":0,"max":100,"x":500,"y":340,"w":180,"h":80,"tabId":"1","format":"bool_onoff"},{"id":"w_1768271020388","type":"indicator","label":"Estado Vent. 1","key":"relay_1_STATE_OUT","min":0,"max":100,"x":500,"y":230,"w":180,"h":80,"tabId":"1","format":"bool_onoff"},{"id":"w_1768271034349","type":"text","label":"Uso Ventiladores Axiales","key":"vfd_1_RUNTIME_OUT","unit":"","min":0,"max":100,"x":700,"y":450,"w":200,"h":90,"tabId":"1","format":"time_hms"},{"id":"w_1768271034900","type":"text","label":"Uso Ventiladores 3 - 4","key":"relay_2_RUNTIME_OUT","unit":"","min":0,"max":100,"x":700,"y":340,"w":200,"h":90,"tabId":"1","format":"time_hms"},{"id":"w_1768271035300","type":"text","label":"Uso Ventiladores 1 - 2","key":"relay_1_RUNTIME_OUT","unit":"","min":0,"max":100,"x":700,"y":230,"w":200,"h":90,"tabId":"1","format":"time_hms"},{"id":"w_1768271035668","type":"text","label":"Uso Bomba de Agua","key":"relay_3_RUNTIME_OUT","unit":"","min":0,"max":100,"x":700,"y":120,"w":200,"h":90,"tabId":"1","format":"time_hms"},{"id":"w_1768271685572","type":"control-relay","label":"Estado Bomba de Agua","key":"relay_3_STATE_OUT","target":"relay_3","min":0,"max":100,"x":30,"y":10,"w":220,"h":120,"tabId":"3","format":"fixed1"},{"id":"w_1768271690253","type":"control-relay","label":"Estado Vent. 1","key":"relay_1_STATE_OUT","target":"relay_1","min":0,"max":100,"x":30,"y":140,"w":220,"h":120,"tabId":"3","format":"fixed1"},{"id":"w_1768271692422","type":"control-relay","label":"Estado Vent. 2","key":"relay_2_STATE_OUT","target":"relay_2","min":0,"max":100,"x":30,"y":270,"w":220,"h":120,"tabId":"3","format":"fixed1"},{"id":"w_1768271697991","type":"control-vfd","label":"Frecuencia Ventiladores Pared","key":"vfd_1_FREQ_OUT","target":"vfd_1","min":0,"max":100,"x":330,"y":110,"w":220,"h":280,"tabId":"3","format":"fixed1"},{"id":"w_1768272928661","type":"control-relay","label":"Estado de Ventiladores Axiales","key":"vfd_1_STATE_OUT","target":"vfd_1","min":0,"max":100,"x":30,"y":400,"w":220,"h":140,"tabId":"3","format":"fixed1"}],"variables":[{"key":"dht22_1_HUM_OUT","label":"Humedad del Invernadero","dataType":"HUM","isDataEmitter":true},{"key":"dht22_1_TEMP_OUT","label":"Temperatura del Invernadero","dataType":"TEMP","isDataEmitter":true},{"key":"ds18b20_2_TEMP_OUT","label":"Temperatura Exterior","dataType":"TEMP","isDataEmitter":true},{"key":"relay_3_STATE_OUT","label":"Estado Bomba de Agua","dataType":"STATE","isDataEmitter":false},{"key":"relay_1_STATE_OUT","label":"Estado Vent. 1","dataType":"STATE","isDataEmitter":false},{"key":"relay_2_STATE_OUT","label":"Estado Vent. 2","dataType":"STATE","isDataEmitter":false},{"key":"vfd_1_FREQ_OUT","label":"Frecuencia Ventiladores Pared","dataType":"","isDataEmitter":true},{"key":"relay_3_RUNTIME_OUT","label":"Uso Bomba de Agua","dataType":"","isDataEmitter":false},{"key":"relay_1_RUNTIME_OUT","label":"Uso Ventiladores 1 - 2","dataType":"","isDataEmitter":false},{"key":"relay_2_RUNTIME_OUT","label":"Uso Ventiladores 3 - 4","dataType":"","isDataEmitter":false},{"key":"vfd_1_STATE_OUT","label":"Estado de Ventiladores Axiales","dataType":"STATE","isDataEmitter":true},{"key":"vfd_1_RUNTIME_OUT","label":"Uso Ventiladores Axiales","dataType":"","isDataEmitter":true},{"key":"ds18b20_1_TEMP_OUT","label":"Temperatura de Pozo","dataType":"TEMP","isDataEmitter":true},{"key":"tsl2561_1_LUX_OUT","label":"Luxes","dataType":"LUX","isDataEmitter":true}],"actuators":[{"id":"relay_1","label":"relay_1","type":"ACT_RELAY_SINGLE"},{"id":"relay_2","label":"relay_2","type":"ACT_RELAY_SINGLE"},{"id":"vfd_1","label":"vfd_1","type":"ACT_VFD_MODBUS"},{"id":"relay_3","label":"relay_3","type":"ACT_RELAY_SINGLE"}]},
            labels: {"dht22_1_HUM_OUT":"Humedad del Invernadero","dht22_1_TEMP_OUT":"Temperatura del Invernadero","ds18b20_2_TEMP_OUT":"Temperatura Exterior","relay_3_STATE_OUT":"Estado Bomba de Agua","relay_1_STATE_OUT":"Estado Vent. 1","relay_2_STATE_OUT":"Estado Vent. 2","vfd_1_FREQ_OUT":"Frecuencia Ventiladores Pared","relay_3_RUNTIME_OUT":"Uso Bomba de Agua","relay_1_RUNTIME_OUT":"Uso Ventiladores 1 - 2","relay_2_RUNTIME_OUT":"Uso Ventiladores 3 - 4","vfd_1_STATE_OUT":"Estado de Ventiladores Axiales","vfd_1_RUNTIME_OUT":"Uso Ventiladores Axiales","ds18b20_1_TEMP_OUT":"Temperatura de Pozo","tsl2561_1_LUX_OUT":"Luxes"},
            refreshInterval: 3000
        };
        
        // L칩gica del Motor de Renderizado (ADTEC Engine)
        
    let activeTabId = CONFIG.dashboard.tabs[0].id;
    let lastData = {};
    let controlState = {};
    let historyData = [];
    let charts = {};

    // ==================== ENGINE CORE ====================
    
    function render() {
        const root = document.getElementById('dashboard-root');
        if (!root) return;

        root.innerHTML = '';
        
        // 1. Renderizar Navegaci칩n de Pesta침as
        const nav = document.createElement('div');
        nav.className = 'tabs-nav';
        nav.innerHTML = CONFIG.dashboard.tabs.map(t => 
            '<div class="tab-btn ' + (activeTabId === t.id ? 'active' : '') + '" onclick="switchTab(\'' + t.id + '\')">' +
            t.icon + ' ' + t.name +
            '</div>'
        ).join('');
        root.appendChild(nav);

        // 2. 츼rea de Widgets (Lienzo Din치mico)
        const tab = CONFIG.dashboard.tabs.find(t => String(t.id) === String(activeTabId));
        if (!tab) return;

        const canvasContainer = document.createElement('div');
        canvasContainer.className = 'dashboard-container';
        canvasContainer.style.width = tab.width + 'px';
        canvasContainer.style.height = tab.height + 'px';
        canvasContainer.innerHTML = '<div class="grid-overlay"></div><div id="widgets-canvas" class="widgets-canvas"></div>';
        root.appendChild(canvasContainer);

        const canvas = canvasContainer.querySelector('#widgets-canvas');
        const widgets = CONFIG.dashboard.widgets.filter(w => String(w.tabId) === String(activeTabId));
        
        canvas.innerHTML = widgets.map(w => renderWidgetMarkup(w)).join('');

        // 3. Inicializar Gr치ficos
        widgets.forEach(w => {
            if (w.type === 'chart' || w.type === 'summary-chart') {
                initChart(w);
            }
        });

        if (window.lucide) lucide.createIcons();
        updateUI();
    }

    function renderWidgetMarkup(w) {
        const style = 'left:' + w.x + 'px; top:' + w.y + 'px; width:' + w.w + 'px; height:' + w.h + 'px; position:absolute;';
        let content = '';

        switch(w.type) {
            case 'gauge':
                content = '<div class="widget-value" id="val_' + w.key + '">--<span class="widget-unit">' + (w.unit || '') + '</span></div>' +
                          '<div class="gauge-bar"><div class="gauge-fill" id="bar_' + w.key + '"></div></div>';
                break;
            case 'indicator':
                content = '<div class="status-chip off" id="chip_' + w.key + '">' +
                          '<span class="status-dot"></span>' +
                          '<span id="label_' + w.key + '">OFFLINE</span>' +
                          '</div>';
                break;
            case 'text':
            case 'datetime':
                content = '<div class="widget-value" style="font-size:16px;" id="val_' + w.key + '">--</div>';
                break;
            case 'control-relay':
                content = '<div class="status-chip off" id="chip_' + w.key + '" style="margin-bottom:10px;">' +
                          '<span class="status-dot"></span> <span id="label_' + w.key + '">ESTADO</span></div>' +
                          '<div style="display:flex; gap:8px;">' +
                          '<button class="control-btn" onclick="sendControl(\'' + w.target + '\', true)">ON</button>' +
                          '<button class="control-btn" onclick="sendControl(\'' + w.target + '\', false)">OFF</button>' +
                          '</div>';
                break;
            case 'control-vfd':
                content = '<div class="widget-value" id="val_' + w.key + '">-- Hz</div>' +
                          '<input type="range" min="0" max="60" step="0.5" style="width:100%; margin:10px 0;" ' +
                          'onchange="sendControl(\'' + w.target + '\', parseFloat(this.value))">' +
                          '<div style="display:flex; gap:8px;">' +
                          '<button class="control-btn" onclick="sendControl(\'' + w.target + '_state\', true)">START</button>' +
                          '<button class="control-btn" onclick="sendControl(\'' + w.target + '_state\', false)">STOP</button>' +
                          '</div>';
                break;
            case 'chart':
            case 'summary-chart':
                content = '<canvas id="chart_' + w.id + '" style="width:100%; height:100%;"></canvas>';
                break;
            case 'label':
                return '<div class="adtec-label-widget" style="position:absolute;' + style + ' color:' + (w.color || 'white') + '; font-size:' + (w.fontSize || 14) + 'px; font-weight:bold; display:flex; align-items:center;">' + w.label + '</div>';
        }

        return '<div class="widget" style="' + style + '">' +
               '<div class="widget-label">' + w.label + '</div>' +
               content +
               '</div>';
    }

    // ==================== DATA & UI LOGIC ====================

    function formatValue(val, format, unit = "") {
        if (val === null || val === undefined) return "--";
        if (format === 'fixed1') return parseFloat(val).toFixed(1) + unit;
        if (format === 'time_hms') {
            const total = parseInt(val);
            const h = Math.floor(total / 3600);
            const m = Math.floor((total % 3600) / 60);
            return h + "h " + m + "m";
        }
        if (format === 'bool_onoff') return (val == 1 || val == "ON" || val == true) ? "ON" : "OFF";
        return val + unit;
    }

    function initChart(w) {
        const canvas = document.getElementById('chart_' + w.id);
        if (!canvas) return;
        const ctx = canvas.getContext('2d');
        const isSummary = w.type === 'summary-chart';
        
        charts[w.id] = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ label: w.label, data: [], borderColor: '#38bdf8', borderWidth: 2, fill: isSummary, tension: 0.4, pointRadius: 0 }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { x: { display: isSummary }, y: { display: isSummary } } }
        });
    }

    function updateUI() {
        CONFIG.dashboard.widgets.forEach(w => {
            const val = lastData[w.key];
            
            // Valores de texto
            const valEl = document.getElementById('val_' + w.key);
            if (valEl) {
                if (w.type === 'datetime' && val) {
                    valEl.innerText = new Date(val).toLocaleString();
                } else {
                    valEl.innerHTML = formatValue(val, w.format, '<span class="widget-unit">' + (w.unit || '') + '</span>');
                }
            }

            // Barras de progreso (Gauges)
            if (w.type === 'gauge' && val !== undefined) {
                const bar = document.getElementById('bar_' + w.key);
                if (bar) {
                    const pct = ((val - (w.min || 0)) / ((w.max || 100) - (w.min || 0))) * 100;
                    bar.style.width = Math.min(100, Math.max(0, pct)) + '%';
                }
            }

            // Indicadores y Rel칠s
            if (w.type === 'indicator' || w.type === 'control-relay') {
                const isOn = (val == 1 || val == true || val == "ON");
                const chip = document.getElementById('chip_' + w.key);
                const label = document.getElementById('label_' + w.key);
                if (chip) {
                    chip.className = 'status-chip ' + (isOn ? 'on' : 'off');
                    if (label) label.innerText = isOn ? 'ACTIVO' : 'INACTIVO';
                }
            }

            // Actualizar Gr치ficos Widget
            if (w.type === 'chart' || w.type === 'summary-chart') {
                const chart = charts[w.id];
                if (chart && historyData.length > 0) {
                    chart.data.labels = historyData.slice(-20).map(d => d.timestamp?.split('T')[1]?.split('.')[0] || '');
                    chart.data.datasets[0].data = historyData.slice(-20).map(d => parseFloat(d[w.key]) || 0);
                    chart.update('none');
                }
            }
        });

        // Banner de Conexi칩n GSM
        const statusText = document.getElementById('conn-status-text');
        const bars = document.getElementById('gsm-signal-bars');
        if (lastData.timestamp) {
            const diff = (new Date() - new Date(lastData.timestamp)) / 1000;
            if (diff < 60) {
                statusText.innerText = "SISTEMA ONLINE";
                statusText.style.color = "var(--success)";
                if (bars) Array.from(bars.children).forEach(b => b.classList.add('active'));
            } else {
                statusText.innerText = "SISTEMA OFFLINE";
                statusText.style.color = "var(--danger)";
                if (bars) Array.from(bars.children).forEach(b => b.classList.remove('active'));
            }
        }
    }

    async function fetchUpdate() {
        try {
            const [rData, rCtrl] = await Promise.all([ fetch('/api/data'), fetch('/api/control_state') ]);
            historyData = await rData.json();
            controlState = await rCtrl.json();
            if (historyData.length > 0) {
                lastData = historyData[historyData.length - 1];
                updateUI();
            }
        } catch(e) { console.error("Update error:", e); }
    }

    async function sendControl(key, val) {
        try {
            await fetch('/api/control_state', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [key]: val })
            });
            controlState[key] = val;
            updateUI();
        } catch(e) { console.error(e); }
    }

    function switchTab(id) { activeTabId = id; render(); }
    
    setInterval(fetchUpdate, CONFIG.refreshInterval);
    window.onload = () => { render(); fetchUpdate(); };

    </script>
</body>
</html>
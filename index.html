<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADTEC Â· Invernadero Pro Dashboard</title>
    
    <!-- Scripts Profesionales (Locales) -->
    <script src="libs/react.production.min.js"></script>
    <script src="libs/react-dom.production.min.js"></script>
    <script src="libs/babel.min.js"></script>
    <script src="libs/lucide.min.js"></script>
    <script src="libs/chart.umd.min.js"></script>

    <style>
        
    :root { 
        --adtec-accent: #38bdf8; 
        --bg: #020617; 
        --surface: rgba(15, 23, 42, 0.8); 
        --border: rgba(148, 163, 184, 0.2); 
        --success: #22c55e; 
        --warn: #fbbf24; 
        --danger: #ef4444;
        --text: #f8fafc; 
        --text-muted: #94a3b8;
    }
    
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    .adtec-dashboard-root {
        padding: 20px;
        display: flex;
        flex-direction: column;
        align-items: center;
        width: 100%;
        min-height: 100vh;
        background: radial-gradient(circle at top, #020617 0, #020617 45%, #000 100%);
        color: #e5e7eb;
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* LA TARJETA MAESTRA: Copia exacta del Editor */
    .adtec-card { 
        background: linear-gradient(145deg, rgba(15,23,42,0.97), rgba(15,23,42,0.7));
        border-radius: 16px; 
        padding: 25px; 
        position: relative; 
        backdrop-filter: blur(20px);
        border: 1px solid rgba(148, 163, 184, 0.35);
        box-shadow: 0 18px 45px rgba(15,23,42,0.9);
        display: flex; 
        flex-direction: column;
        overflow: hidden;
    }

    .card-header { 
        display: flex; 
        justify-content: space-between; 
        align-items: center; 
        margin-bottom: 20px; 
        border-bottom: 1px solid rgba(148, 163, 184, 0.2); 
        padding-bottom: 15px; 
    }
    
    .logo-section { display: flex; align-items: center; gap: 12px; }
    .logo-icon { 
        width: 30px; height: 30px; 
        background: #fbbf24; 
        border-radius: 8px;
        display: flex; align-items: center; justify-content: center;
        box-shadow: 0 0 15px rgba(251, 191, 36, 0.4);
    }
    .logo-icon-inner { font-size: 9px; font-weight: 900; color: black; letter-spacing: -0.5px; }
    .card-title { font-weight: 600; font-size: 18px; letter-spacing: 0.05em; color: #f8fafc; margin: 0; }

    .tabs-nav { display: flex; gap: 8px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; width: 100%; justify-content: center; }
    .tab-btn { 
        padding: 10px 20px; cursor: pointer; border-radius: 10px; font-size: 12px; font-weight: 700;
        transition: all 0.2s; color: var(--text-muted); border: 1px solid transparent;
        display: flex; align-items: center; gap: 10px; white-space: nowrap; text-transform: uppercase;
    }
    .tab-btn:hover { background: rgba(255,255,255,0.05); color: var(--text); }
    .tab-btn.active { background: rgba(56, 189, 248, 0.1); border-color: rgba(56, 189, 248, 0.2); color: var(--adtec-accent); }

    .card-body { 
        position: relative; background: rgba(0,0,0,0.2); border-radius: 12px; 
        border: 1px solid rgba(148, 163, 184, 0.1); overflow: hidden; flex: 1;
        display: flex; flex-direction: column;
    }
    .grid-bg { 
        position: absolute; inset: 0; 
        background-image: radial-gradient(rgba(56, 189, 248, 0.05) 1px, transparent 1px); 
        background-size: 30px 30px; opacity: 0.5; pointer-events: none;
    }

    .widgets-area { position: relative; width: 100%; height: 100%; z-index: 1; flex: 1; }

    /* LOS WIDGETS: Copia exacta del Editor */
    .adtec-status-item { 
        position: absolute; padding: 12px 14px; border-radius: 12px;
        background: radial-gradient(circle at top, rgba(15,118,110,0.15), rgba(15,23,42,0.96));
        border: 1px solid rgba(45,212,191,0.2);
        display: flex; flex-direction: column; gap: 4px;
        transition: all 0.3s ease; backdrop-filter: blur(5px);
    }
    .adtec-status-item h3 { font-size: 10px; text-transform: uppercase; letter-spacing: 0.08em; color: #9ca3af; margin: 0; font-weight: 700; }
    .adtec-status-value { font-size: 20px; font-weight: 700; color: var(--adtec-accent); }
    .adtec-status-sub { font-size: 10px; color: #9ca3af; }
    
    .adtec-temp-bar { 
        width: 100%; height: 6px; background: rgba(15,23,42,0.8); 
        border: 1px solid rgba(148, 163, 184, 0.2); border-radius: 4px; 
        overflow: hidden; margin-top: 5px; position: relative; 
    }
    .adtec-temp-bar-fill { 
        height: 100%; width: 0%; background: var(--adtec-accent);
        box-shadow: 0 0 10px rgba(56, 189, 248, 0.4);
        transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1); 
    }

    .adtec-status-chip { 
        display: inline-flex; align-items: center; gap: 6px; padding: 3px 10px; 
        border-radius: 999px; font-size: 10px; font-weight: 700; margin-top: auto; 
        border: 1px solid rgba(148, 163, 184, 0.3); text-transform: uppercase; letter-spacing: 0.5px;
    }
    .adtec-status-chip.on { background: rgba(34,197,94,0.1); color: #22c55e; border-color: rgba(34,197,94,0.4); }
    .adtec-status-chip.warn { background: rgba(251,191,36,0.1); color: #fbbf24; border-color: rgba(251,191,36,0.4); }
    .adtec-status-chip.off { background: rgba(239,68,68,0.1); color: #ef4444; border-color: rgba(239,68,68,0.4); }
    
    .adtec-status-dot { width: 7px; height: 7px; border-radius: 50%; background: #9ca3af; }
    .adtec-status-dot.on { background: #22c55e; box-shadow: 0 0 10px #22c55e; }
    .adtec-status-dot.warn { background: #fbbf24; box-shadow: 0 0 10px #fbbf24; }
    .adtec-status-dot.off { background: #ef4444; box-shadow: 0 0 10px #ef4444; }

    .vfd-btn { 
        flex: 1; padding: 6px; border-radius: 4px; 
        border: 1px solid rgba(255,255,255,0.1); color: white; 
        font-weight: 800; font-size: 10px; cursor: pointer; 
        transition: all 0.2s; background: rgba(255,255,255,0.05);
        text-transform: uppercase; letter-spacing: 0.05em;
        display: inline-flex; align-items: center; justify-content: center; gap: 4px;
    }
    .vfd-btn:hover { background: rgba(255,255,255,0.1); }
    .vfd-btn:active { transform: scale(0.98); }
    .vfd-btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .vfd-btn.start { background: rgba(34, 197, 94, 0.2); color:rgb(214, 245, 245); border-color: #22c55e; }
    .vfd-btn.stop { background: rgba(239, 68, 68, 0.2); color:rgb(255, 204, 204); border-color: #ef4444; }

    .adtec-security-banner {
        margin-top: 25px; padding: 15px 20px; 
        background: rgba(250,204,21,0.05); border-radius: 10px; 
        border: 1px solid rgba(250,204,21,0.2); display: flex; 
        gap: 15px; alignItems: center;
    }
    .adtec-security-banner p { margin: 0; fontSize: 11px; color: #fbbf24; lineHeight: 1.5; }


    .vfd-dial {
        width: 100px; height: 100px; border-radius: 50%; border: 6px solid #1e293b; 
        display: flex; flex-direction: column; align-items: center; justify-content: center;
        background: rgba(0,0,0,0.2); transition: all 0.3s ease; position: relative;
    }
    .vfd-dial.on { border-top-color: var(--adtec-accent); box-shadow: 0 0 15px rgba(56,189,248,0.2); }
    .vfd-dial-value { font-size: 18px; font-weight: 900; color: white; }
    .vfd-dial.on .vfd-dial-value { color: var(--adtec-accent); }
    .vfd-dial-unit { font-size: 8px; color: #9ca3af; }

    .switch { position: relative; display: inline-block; width: 38px; height: 22px; transform: scale(0.7); }
    .switch input { opacity: 0; width: 0; height: 0; }
    .slider { 
        position: absolute; cursor: pointer; inset: 0; 
        background-color: rgba(148, 163, 184, 0.2); transition: .2s; border-radius: 22px; 
    }
    .slider:before { 
        position: absolute; content: ""; height: 16px; width: 16px; 
        left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; 
    }
    input:checked + .slider { background-color: var(--adtec-accent); }
    input:checked + .slider:before { transform: translateX(16px); }

    .gsm-bars { display: flex; gap: 2px; align-items: flex-end; height: 20px; }
    .gsm-bar { width: 3px; background: rgba(255,255,255,0.1); border-radius: 1px; }
    .gsm-bar.active { background: var(--adtec-accent); box-shadow: 0 0 8px var(--adtec-accent); }

    .adtec-label-widget {
        pointer-events: none; white-space: pre-wrap; font-family: 'Segoe UI', sans-serif;
        display: flex; align-items: center; justify-content: center; text-align: center;
    }

        body { 
            margin: 0; 
            padding: 0; 
            background: #020617; 
            overflow-x: hidden; 
        }
    </style>
</head>
<body>
    <div id="dashboard-root"></div>
    <script type="text/babel">
        
        const CONFIG = {
            dashboard: {"tabs":[{"id":"1","name":"Estado Actual","icon":"layout-dashboard","title":"Estado Actual del Invernadero","width":970,"height":800,"type":"dashboard"},{"id":"2","name":"Grafico","icon":"activity","title":"Laboratorio de GrÃ¡ficos","width":1000,"height":700,"type":"charts"},{"id":"3","name":"Control","icon":"sliders","title":"Control Remoto de Invernadero","width":700,"height":800,"type":"control"},{"id":"4","name":"Alertas","icon":"bell","title":"Alertas del Sistema","width":1000,"height":700,"type":"dashboard"}],"widgets":[{"id":"w_1768270825285","type":"gauge","label":"Humedad del Invernadero","key":"dht22_1_HUM_OUT","unit":"%","min":0,"max":100,"x":240,"y":10,"w":220,"h":180,"tabId":"1","format":"fixed1","hideKey":true},{"id":"w_1768270831388","type":"gauge","label":"Temperatura del Invernadero","key":"dht22_1_TEMP_OUT","unit":"Â°C","min":0,"max":50,"x":10,"y":10,"w":220,"h":180,"tabId":"1","format":"fixed1","hideKey":true},{"id":"w_1768270903173","type":"gauge","label":"Temperatura Exterior","key":"ds18b20_2_TEMP_OUT","unit":"Â°C","min":0,"max":50,"x":10,"y":210,"w":220,"h":180,"tabId":"1","format":"fixed1","hideKey":true},{"id":"w_1768270908326","type":"gauge","label":"Temperatura de Pozo","key":"ds18b20_1_TEMP_OUT","unit":"Â°C","min":0,"max":50,"x":240,"y":210,"w":220,"h":180,"tabId":"1","format":"fixed1","hideKey":true},{"id":"w_1768270938829","type":"gauge","label":"Frecuencia Ventiladores Pared","key":"vfd_1_FREQ_OUT","unit":"Hz","min":0,"max":70,"x":10,"y":410,"w":220,"h":180,"tabId":"1","format":"fixed1","inverted":false,"hideKey":true},{"id":"w_1768270972142","type":"gauge","label":"Luxes","key":"tsl2561_1_LUX_OUT","unit":"LX","min":0,"max":40000,"x":240,"y":410,"w":220,"h":180,"tabId":"1","format":"fixed1","hideKey":true},{"id":"w_1768270996596","type":"indicator","label":"Estado Bomba de Agua","key":"relay_3_STATE_OUT","min":0,"max":100,"x":500,"y":120,"w":180,"h":80,"tabId":"1","format":"bool_onoff","hideKey":true},{"id":"w_1768271000492","type":"location","label":"Coordenadas","key":"gsm_1_LOCATION","min":0,"max":100,"x":710,"y":590,"w":200,"h":85,"tabId":"1","format":"fixed1","hideKey":true},{"id":"w_1768271000964","type":"datetime","label":"Reloj Sistema","key":"timestamp","min":0,"max":100,"x":480,"y":10,"w":220,"h":85,"tabId":"1","format":"raw","unit":"","hideKey":true},{"id":"w_1768271019292","type":"indicator","label":"Estado de Ventiladores Axiales","key":"vfd_1_STATE_OUT","min":0,"max":100,"x":500,"y":450,"w":180,"h":80,"tabId":"1","format":"bool_onoff","hideKey":true},{"id":"w_1768271019940","type":"indicator","label":"Estado Vent. 2","key":"relay_2_STATE_OUT","min":0,"max":100,"x":500,"y":340,"w":180,"h":80,"tabId":"1","format":"bool_onoff","hideKey":true},{"id":"w_1768271020388","type":"indicator","label":"Estado Vent. 1","key":"relay_1_STATE_OUT","min":0,"max":100,"x":500,"y":230,"w":180,"h":80,"tabId":"1","format":"bool_onoff","hideKey":true},{"id":"w_1768271034349","type":"text","label":"Uso Ventiladores Axiales","key":"vfd_1_RUNTIME_OUT","unit":"","min":0,"max":10000,"x":700,"y":450,"w":200,"h":90,"tabId":"1","format":"time_hms","hideKey":true},{"id":"w_1768271034900","type":"text","label":"Uso Ventiladores 3 - 4","key":"relay_2_RUNTIME_OUT","unit":"","min":0,"max":10000,"x":700,"y":340,"w":200,"h":90,"tabId":"1","format":"time_hms","hideKey":true},{"id":"w_1768271035300","type":"text","label":"Uso Ventiladores 1 - 2","key":"relay_1_RUNTIME_OUT","unit":"","min":0,"max":10000,"x":700,"y":230,"w":200,"h":90,"tabId":"1","format":"time_hms","hideKey":true},{"id":"w_1768271035668","type":"text","label":"Uso Bomba de Agua","key":"relay_3_RUNTIME_OUT","unit":"","min":0,"max":10000,"x":700,"y":120,"w":200,"h":90,"tabId":"1","format":"time_hms","hideKey":true},{"id":"w_1768271685572","type":"control-relay","label":"Estado Bomba de Agua","key":"relay_3_STATE_OUT","target":"relay_3","min":0,"max":100,"x":30,"y":20,"w":300,"h":120,"tabId":"3","format":"fixed1","hideKey":true},{"id":"w_1768271690253","type":"control-relay","label":"Estado Vent. 1","key":"relay_1_STATE_OUT","target":"relay_1","min":0,"max":100,"x":30,"y":150,"w":300,"h":120,"tabId":"3","format":"fixed1","hideKey":true},{"id":"w_1768271692422","type":"control-relay","label":"Estado Vent. 2","key":"relay_2_STATE_OUT","target":"relay_2","min":0,"max":100,"x":30,"y":280,"w":300,"h":120,"tabId":"3","format":"fixed1","hideKey":true},{"id":"w_1768271697991","type":"control-vfd","label":"Frecuencia Ventiladores Pared","key":"vfd_1_FREQ_OUT","target":"vfd_1","min":0,"max":100,"x":370,"y":150,"w":250,"h":280,"tabId":"3","format":"fixed1","hideKey":true},{"id":"w_1768272928661","type":"control-relay","label":"Estado de Ventiladores Axiales","key":"vfd_1_STATE_OUT","target":"vfd_1","min":0,"max":100,"x":30,"y":410,"w":300,"h":140,"tabId":"3","format":"fixed1","hideKey":true},{"id":"w_1768373240835","type":"text","label":"Nuevo text","key":"sin_key","unit":"","min":0,"max":0,"x":50,"y":20,"w":850,"h":90,"tabId":"4","format":"raw","borderRadius":12,"boxShadow":"0 0 10px","hideKey":true},{"id":"w_1768400611507","type":"connection","label":"Estado Red","key":"gsm_signal","min":0,"max":100,"x":720,"y":10,"w":180,"h":85,"tabId":"1","format":"fixed1","borderRadius":12,"boxShadow":"0 0 10px","signalKey":"gsm_1_SIGNAL","statusKey":"gsm_1_STATE","hideKey":true}],"variables":[{"key":"dht22_1_HUM_OUT","label":"Humedad del Invernadero","dataType":"HUM"},{"key":"dht22_1_TEMP_OUT","label":"Temperatura del Invernadero","dataType":"TEMP"},{"key":"ds18b20_2_TEMP_OUT","label":"Temperatura Exterior","dataType":"TEMP"},{"key":"relay_3_STATE_OUT","label":"Estado Bomba de Agua","dataType":"STATE"},{"key":"relay_1_STATE_OUT","label":"Estado Vent. 1","dataType":"STATE"},{"key":"relay_2_STATE_OUT","label":"Estado Vent. 2","dataType":"STATE"},{"key":"vfd_1_FREQ_OUT","label":"Frecuencia Ventiladores Pared","dataType":""},{"key":"relay_3_RUNTIME_OUT","label":"Uso Bomba de Agua","dataType":""},{"key":"relay_1_RUNTIME_OUT","label":"Uso Ventiladores 1 - 2","dataType":""},{"key":"relay_2_RUNTIME_OUT","label":"Uso Ventiladores 3 - 4","dataType":""},{"key":"vfd_1_STATE_OUT","label":"Estado de Ventiladores Axiales","dataType":"STATE"},{"key":"vfd_1_RUNTIME_OUT","label":"Uso Ventiladores Axiales","dataType":""},{"key":"ds18b20_1_TEMP_OUT","label":"Temperatura de Pozo","dataType":"TEMP"},{"key":"tsl2561_1_LUX_OUT","label":"Luxes","dataType":"LUX"},{"key":"gsm_1_SIGNAL","label":"SeÃ±al GSM","dataType":"SIGNAL"},{"key":"gsm_1_STATE","label":"Estado de Red GSM","dataType":"STATE"},{"key":"gsm_1_LOCATION","label":"Coordenadas","dataType":"LOCATION"}],"actuators":[{"id":"relay_1","label":"relay_1","type":"ACT_RELAY_SINGLE"},{"id":"relay_2","label":"relay_2","type":"ACT_RELAY_SINGLE"},{"id":"vfd_1","label":"vfd_1","type":"ACT_VFD_MODBUS"},{"id":"relay_3","label":"relay_3","type":"ACT_RELAY_SINGLE"}]},
            labels: {"dht22_1_HUM_OUT":"Humedad del Invernadero","dht22_1_TEMP_OUT":"Temperatura del Invernadero","ds18b20_2_TEMP_OUT":"Temperatura Exterior","relay_3_STATE_OUT":"Estado Bomba de Agua","relay_1_STATE_OUT":"Estado Vent. 1","relay_2_STATE_OUT":"Estado Vent. 2","vfd_1_FREQ_OUT":"Frecuencia Ventiladores Pared","relay_3_RUNTIME_OUT":"Uso Bomba de Agua","relay_1_RUNTIME_OUT":"Uso Ventiladores 1 - 2","relay_2_RUNTIME_OUT":"Uso Ventiladores 3 - 4","vfd_1_STATE_OUT":"Estado de Ventiladores Axiales","vfd_1_RUNTIME_OUT":"Uso Ventiladores Axiales","ds18b20_1_TEMP_OUT":"Temperatura de Pozo","tsl2561_1_LUX_OUT":"Luxes","gsm_1_SIGNAL":"SeÃ±al GSM","gsm_1_STATE":"Estado de Red GSM","gsm_1_LOCATION":"Coordenadas"},
            refreshInterval: 1000,
            chartConfig: {
                primaryY: '',
                secondaryY: '',
                timeRange: 'Ahora'
            }
        };
        
        const formatValue = (val, format, unit = "") => {
            if (val === null || val === undefined || val === '--') return "--";
            const num = parseFloat(val);
            const isNum = !isNaN(num);
            if (format === 'fixed1') return (isNum ? num.toFixed(1) : val) + unit;
            if (format === 'fixed2') return (isNum ? num.toFixed(2) : val) + unit;
            if (format === 'time_hm' || format === 'time_hms') {
                const totalSeconds = Math.floor(isNum ? num : 0);
                const h = Math.floor(totalSeconds / 3600);
                const m = Math.floor((totalSeconds % 3600) / 60);
                const s = totalSeconds % 60;
                if (format === 'time_hm') return h + "h " + m + "m";
                return h + ":" + m.toString().padStart(2, '0') + ":" + s.toString().padStart(2, '0');
            }
            if (format === 'datetime' || (typeof val === 'string' && val.includes('T') && val.includes(':'))) {
                try {
                    const date = new Date(val);
                    if (!isNaN(date.getTime())) {
                        return date.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    }
                } catch (e) { }
            }
            if (format === 'bool_onoff') return (val == 1 || val == "ON" || val == true) ? "ON" : "OFF";
            if (format === 'percent') return (isNum ? num.toFixed(0) : val) + "%";
            if (isNum && typeof val === 'number') return num.toFixed(1) + unit;
            return val + unit;
        };

        const getGaugeColor = (val, key = "") => {
            const num = parseFloat(val);
            if (isNaN(num)) return '#10b981';
            if (key.toLowerCase().includes('temp')) {
                if (num < 15) return '#3b82f6';
                if (num < 30) return '#10b981';
                if (num < 35) return '#f59e0b';
                return '#ef4444';
            }
            if (key.toLowerCase().includes('hum')) {
                if (num < 40) return '#ef4444';
                if (num < 70) return '#10b981';
                return '#f59e0b';
            }
            if (num < 20) return '#10b981';
            if (num < 80) return '#f59e0b';
            return '#ef4444';
        };

        const getGradientByType = (type, alpha, inverted) => {
            let stops = [{ pos: 0, color: '#10b981' }, { pos: 50, color: '#f59e0b' }, { pos: 100, color: '#ef4444' }];
            if (inverted) {
                const colors = stops.map(s => s.color).reverse();
                stops = stops.map((s, i) => ({ ...s, color: colors[i] }));
            }
            const alphaHex = Math.floor(alpha * 255).toString(16).padStart(2, '0');
            return "linear-gradient(90deg, " + stops.map(s => s.color + alphaHex + " " + s.pos + "%").join(", ") + ")";
        };

        const getWidgetValueShared = (key, state, widgets) => {
            if (!state) return '--';
            if (key.toLowerCase() === 'alert_msg' || key.toLowerCase() === 'ultima_alerta' || key.toLowerCase() === 'alerta') {
                const alerts = state.activeAlerts || [];
                if (alerts.length === 0) return 'ðŸŸ¢ SISTEMA OK';
                const lastAlert = alerts[alerts.length - 1];
                return (lastAlert.type === 'CRITICAL' ? 'ðŸ”´' : 'ðŸŸ¡') + ' ' + lastAlert.message;
            }
            let val = state.telemetry ? state.telemetry[key] : state[key];
            if (val === undefined && state.data && typeof state.data === 'object') val = state.data[key];
            if (val === undefined && state.blocks) {
                for (const blockId in state.blocks) {
                    if (state.blocks[blockId][key] !== undefined) {
                        val = state.blocks[blockId][key];
                        break;
                    }
                }
            }
            if (val === undefined && key.includes('.')) {
                const [blockId, prop] = key.split('.');
                const block = state.blocks && state.blocks[blockId];
                val = block && (block[prop.toLowerCase()] || block[prop]);
            }
            if (val === undefined) return '--';
            const widget = widgets.find(w => w.key === key);
            return formatValue(val, widget && widget.format, widget && widget.unit);
        };
  
        
const { useState, useEffect, useMemo, useRef, useCallback } = React;

// Componente de GrÃ¡fico Optimizado (Zero-Flicker)
const DashboardChart = React.memo(({ widget, dataHistory, chartConfig }) => {
    const canvasRef = useRef(null);
    const chartRef = useRef(null);

    // Obtener configuraciÃ³n de escala (min/max) desde los widgets
    const getScaleSettings = (key) => {
        if (!key) return { min: undefined, max: undefined };
        const w = CONFIG.dashboard.widgets.find(w => w.key === key);
        if (!w || (w.min === 0 && w.max === 0)) return { min: undefined, max: undefined };
        return { min: w.min, max: w.max };
    };

    useEffect(() => {
        if (!canvasRef.current || typeof Chart === 'undefined') return;

        const ctx = canvasRef.current.getContext('2d');
        const primaryLimits = getScaleSettings(chartConfig && chartConfig.primaryY);
        const secondaryLimits = getScaleSettings(chartConfig && chartConfig.secondaryY);

        chartRef.current = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Eje Principal',
                        data: [],
                        borderColor: '#38bdf8',
                        backgroundColor: 'rgba(56, 189, 248, 0.1)',
                        borderWidth: 2,
                        fill: true,
                        tension: 0.3,
                        pointRadius: 0,
                        yAxisID: 'y'
                    },
                    {
                        label: 'Eje Secundario',
                        data: [],
                        borderColor: '#a855f7',
                        backgroundColor: 'rgba(168, 85, 247, 0.05)',
                        borderWidth: 2,
                        fill: false,
                        tension: 0.3,
                        pointRadius: 0,
                        yAxisID: 'y1',
                        hidden: !(chartConfig && chartConfig.secondaryY)
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                animation: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                scales: {
                    x: { 
                        display: true,
                        grid: { color: 'rgba(255,255,255,0.03)' },
                        ticks: { 
                            color: '#64748b', 
                            font: { size: 9 },
                            maxRotation: 0,
                            autoSkip: true,
                            maxTicksLimit: 8 
                        }
                    },
                    y: {
                        display: true,
                        position: 'left',
                        beginAtZero: false,
                        min: primaryLimits.min,
                        max: primaryLimits.max,
                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { color: '#38bdf8', font: { size: 10 } } 
                    },
                    y1: {
                        display: !!(chartConfig && chartConfig.secondaryY),
                        position: 'right',
                        beginAtZero: false,
                        min: secondaryLimits.min,
                        max: secondaryLimits.max,
                        grid: { drawOnChartArea: false }, 
                        ticks: { color: '#a855f7', font: { size: 10 } }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        enabled: true,
                        backgroundColor: 'rgba(15, 23, 42, 0.95)',
                        titleColor: '#fff',
                        titleFont: { size: 11, weight: 'bold' },
                        bodyFont: { size: 12 },
                        padding: 10,
                        borderColor: 'rgba(255,255,255,0.1)',
                        borderWidth: 1,
                        callbacks: {
                            title: (items) => {
                                const item = items[0];
                                const rawData = dataHistory[item.dataIndex];
                                if (!rawData || !rawData.fullTimestamp) return item.label;
                                const d = new Date(rawData.fullTimestamp);
                                return d.toLocaleDateString('es-ES') + ' ' + d.toLocaleTimeString('es-ES');
                            },
                            label: (item) => {
                                const label = item.dataset.label || '';
                                const value = item.formattedValue;
                                const unitKey = (item.datasetIndex === 0 ? (chartConfig && chartConfig.primaryY) : (chartConfig && chartConfig.secondaryY));
                                const widgetFound = CONFIG.dashboard.widgets.find(w => w.key === unitKey);
                                const unit = (widgetFound && widgetFound.unit) || '';
                                return label + ': ' + value + ' ' + unit;
                            }
                        }
                    }
                }
            }
        });

        return () => {
            if (chartRef.current) chartRef.current.destroy();
        };
    }, []);

    useEffect(() => {
        const chart = chartRef.current;
        if (!chart) return;
        
        const data = dataHistory || [];
        const primaryLimits = getScaleSettings(chartConfig && chartConfig.primaryY);
        const secondaryLimits = getScaleSettings(chartConfig && chartConfig.secondaryY);

        // Actualizar nombres de variables
        const v1Label = CONFIG.labels[chartConfig && chartConfig.primaryY] || (chartConfig && chartConfig.primaryY) || 'Variable 1';
        const v2Label = CONFIG.labels[chartConfig && chartConfig.secondaryY] || (chartConfig && chartConfig.secondaryY) || 'Variable 2';

        chart.data.labels = data.map(d => d.t);
        chart.data.datasets[0].data = data.map(d => d.v);
        chart.data.datasets[0].label = v1Label;

        if (chartConfig && chartConfig.secondaryY) {
            chart.data.datasets[1].data = data.map(d => d.v2);
            chart.data.datasets[1].label = v2Label;
            chart.data.datasets[1].hidden = false;
            chart.options.scales.y1.display = true;
        } else {
            chart.data.datasets[1].hidden = true;
            chart.options.scales.y1.display = false;
        }

        // Actualizar lÃ­mites dinÃ¡micamente
        chart.options.scales.y.min = primaryLimits.min;
        chart.options.scales.y.max = primaryLimits.max;
        chart.options.scales.y1.min = secondaryLimits.min;
        chart.options.scales.y1.max = secondaryLimits.max;

        chart.update('none');
    }, [dataHistory, chartConfig]);

    return <canvas ref={canvasRef} style={{ display: 'block', width: '100%', height: '100%' }} />;
});

const DashboardApp = () => {
    const [activeTabId, setActiveTabId] = useState((CONFIG.dashboard.tabs[0] && CONFIG.dashboard.tabs[0].id) || '0');
    const [lastData, setLastData] = useState({});
    const [controlState, setControlState] = useState({});
    const [historyData, setHistoryData] = useState([]); 
    const [liveData, setLiveData] = useState([]); 
    const [chartConfig, setChartConfig] = useState({
        ...CONFIG.chartConfig,
        filter: 'all',
        fromDate: '',
        toDate: '',
        timeRange: 'Ahora'
    });
    const [connStatus, setConnStatus] = useState('OFFLINE');
    const [connColor, setConnColor] = useState('#ef4444');

    // Memoria persistente para ubicaciÃ³n (Latching)
    const [lastValidLocation, setLastValidLocation] = useState({ city: '--', coord: '--' });

    useEffect(() => {
        const currentLoc = getWidgetValueShared('gsm_location', lastData, CONFIG.dashboard.widgets);
        const currentCity = getWidgetValueShared('gsm_city_country', lastData, CONFIG.dashboard.widgets);
        
        if (currentLoc !== '--' && currentLoc !== '') {
            setLastValidLocation(prev => ({
                city: (currentCity !== '--' && currentCity !== '') ? currentCity : prev.city,
                coord: currentLoc
            }));
        }
    }, [lastData]);

    const getWidgetValue = (key) => getWidgetValueShared(key, lastData, CONFIG.dashboard.widgets);

    const currentTab = useMemo(() => 
        CONFIG.dashboard.tabs.find(t => String(t.id) === String(activeTabId)) || CONFIG.dashboard.tabs[0] || { width: 1000, height: 700 }
    , [activeTabId, CONFIG.dashboard.tabs]);

    useEffect(() => {
        if (!chartConfig.primaryY && CONFIG.dashboard.variables && CONFIG.dashboard.variables.length > 0) {
            setChartConfig(prev => ({ ...prev, primaryY: CONFIG.dashboard.variables[0].key }));
        }
    }, []);

    const fetchHistory = async () => {
        if (chartConfig.timeRange === 'Ahora') return;
        try {
            const res = await fetch('/api/data');
            if (res.ok) {
                const fullHistory = await res.json();
                setHistoryData(fullHistory);
            }
        } catch(e) { console.error("Error historial:", e); }
    };

    const fetchUpdate = async () => {
        try {
            const res = await fetch('/api/last');
            if (res.ok) {
                const data = await res.json();
                setLastData(data);
                
                if (chartConfig.timeRange === 'Ahora' && data) {
                    const timestamp = data.timestamp || new Date().toISOString();
                    const tLabel = new Date(timestamp).toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                    const val1 = parseFloat(data[chartConfig.primaryY]);
                    const val2 = chartConfig.secondaryY ? parseFloat(data[chartConfig.secondaryY]) : null;
                    
                    if (!isNaN(val1)) {
                        setLiveData(prev => {
                            const next = [...prev, { 
                                t: tLabel, 
                                v: val1, 
                                v2: val2,
                                fullTimestamp: timestamp 
                            }];
                            return next.length > 100 ? next.slice(-100) : next;
                        });
                    }
                }

                if ((data && data.timestamp) || (data && Object.keys(data).length > 0)) {
                    setConnStatus("ONLINE");
                    setConnColor("var(--success)");
                } else {
                    setConnStatus("OFFLINE");
                    setConnColor("var(--danger)");
                }
            }
        } catch(e) { console.warn("Fallo TelemetrÃ­a:", e); }

        try {
            const res = await fetch('/api/control_state');
            if (res.ok) {
                setControlState(await res.json());
            }
        } catch(e) { console.warn("Fallo Controles:", e); }
    };

    const displayData = useMemo(() => {
        if (chartConfig.timeRange === 'Ahora') return liveData;

        let filtered = historyData;
        const now = new Date().getTime();

        // 1. Filtro de Tiempo (Rango RÃ¡pido)
        if (chartConfig.timeRange === '24h') {
            const oneDayAgo = now - (24 * 60 * 60 * 1000);
            filtered = historyData.filter(d => new Date(d.timestamp).getTime() >= oneDayAgo);
        } else if (chartConfig.timeRange === '7d') {
            const sevenDaysAgo = now - (7 * 24 * 60 * 60 * 1000);
            filtered = historyData.filter(d => new Date(d.timestamp).getTime() >= sevenDaysAgo);
        } else if (chartConfig.timeRange === 'Rango') {
            if (chartConfig.fromDate && chartConfig.toDate) {
                const start = new Date(chartConfig.fromDate).getTime();
                const end = new Date(chartConfig.toDate).getTime();
                filtered = historyData.filter(d => {
                    const ts = new Date(d.timestamp).getTime();
                    return ts >= start && ts <= end;
                });
            }
        }

        // 2. Filtro Horario (DÃ­a / Noche)
        if (chartConfig.filter === 'day') {
            filtered = filtered.filter(d => {
                const h = new Date(d.timestamp).getHours();
                return h >= 7 && h < 19;
            });
        } else if (chartConfig.filter === 'night') {
            filtered = filtered.filter(d => {
                const h = new Date(d.timestamp).getHours();
                return h < 7 || h >= 19;
            });
        }

        return filtered.map(d => {
            const ts = new Date(d.timestamp);
            const label = ts.toLocaleDateString('es-ES', { day: '2-digit', month: '2-digit' }) + ' ' + ts.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            return {
                t: label,
                v: parseFloat(d[chartConfig.primaryY]),
                v2: chartConfig.secondaryY ? parseFloat(d[chartConfig.secondaryY]) : null,
                fullTimestamp: d.timestamp
            };
        }).filter(d => !isNaN(d.v));
    }, [chartConfig, historyData, liveData]);

    const sendControl = async (key, val) => {
        try {
            const res = await fetch('/api/control_state', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ [key]: val })
            });
            if (res.ok) {
                setControlState(prev => ({ ...prev, [key]: val }));
            }
        } catch(e) { console.error("Error envÃ­o control:", e); }
    };

    useEffect(() => {
        fetchHistory();
    }, [chartConfig.timeRange, chartConfig.fromDate, chartConfig.toDate]);

    useEffect(() => {
        fetchUpdate();
        const interval = setInterval(fetchUpdate, CONFIG.refreshInterval);
        return () => clearInterval(interval);
    }, [chartConfig.primaryY, chartConfig.secondaryY, chartConfig.timeRange]);

    useEffect(() => {
        setTimeout(() => { if(window.lucide) lucide.createIcons(); }, 100);
    }, [activeTabId]);

    const activeVarLabel = useMemo(() => {
        return CONFIG.labels[chartConfig.primaryY] || chartConfig.primaryY;
    }, [chartConfig.primaryY]);

    return (
        <div className="adtec-dashboard-root">
            <div className="tabs-nav">
                {CONFIG.dashboard.tabs.map(t => (
                    <div 
                        key={t.id} 
                        className={"tab-btn " + (activeTabId === t.id ? "active" : "")} 
                        onClick={() => setActiveTabId(t.id)}
                    >
                        <i data-lucide={t.icon}></i> {t.name}
                    </div>
                ))}
            </div>

            <div className="adtec-card" style={{ width: currentTab.width + 'px', minHeight: currentTab.height + 'px', margin: '0 auto' }}>
                <div className="card-header">
                    <div className="logo-section">
                        <div className="logo-icon"><div className="logo-icon-inner">ADTEC</div></div>
                        <span className="card-title">{currentTab.title}</span>
                    </div>
                    <div style={{ display: 'flex', alignItems: 'center', gap: '15px' }}>
                        {currentTab.type === 'control' && (
                            <div style={{ display: 'flex', alignItems: 'center', gap: '10px', background: 'rgba(255,255,255,0.05)', padding: '5px 12px', borderRadius: '20px', border: '1px solid rgba(148,163,184,0.1)' }}>
                                <span style={{ fontSize: '9px', fontWeight: 700, color: controlState.manual ? 'var(--adtec-accent)' : '#9ca3af' }}>
                                    {controlState.manual ? 'MANUAL' : 'AUTO'}
                                </span>
                                <label className="switch">
                                    <input type="checkbox" checked={!!controlState.manual} onChange={(e) => sendControl('manual', e.target.checked)} />
                                    <span className="slider"></span>
                                </label>
                            </div>
                        )}
                        {currentTab.type === 'charts' && (
                            <div style={{ display: 'flex', gap: 8 }}>
                                <button 
                                    onClick={() => setChartConfig(prev => ({
                                        ...prev,
                                        primaryY: (CONFIG.dashboard.variables && CONFIG.dashboard.variables[0]?.key) || '',
                                        secondaryY: '',
                                        filter: 'all',
                                        fromDate: '',
                                        toDate: '',
                                        timeRange: 'Ahora'
                                    }))}
                                    style={{ padding: '5px 10px', borderRadius: 6, background: 'rgba(255,255,255,0.05)', color: '#9ca3af', border: '1px solid rgba(148,163,184,0.1)', cursor: 'pointer', fontSize: 10 }}
                                >Reset filtros</button>
                                <a href="/api/download/csv" style={{ padding: '5px 10px', borderRadius: 6, background: 'var(--adtec-accent)', color: 'black', border: 'none', cursor: 'pointer', fontWeight: 700, fontSize: 10, textDecoration: 'none' }}>CSV</a>
                            </div>
                        )}
                        <div style={{ fontSize: '11px', fontWeight: '800', color: connColor }}>{connStatus}</div>
                    </div>
                </div>

                <div className="card-body">
                    <div className="grid-bg"></div>
                    
                    {currentTab.type === 'charts' ? (
                        <div style={{ flex: 1, position: 'relative', overflowY: 'auto', padding: 20 }}>
                            <div style={{ background: 'rgba(255,255,255,0.03)', padding: 15, borderRadius: 12, border: '1px solid rgba(148,163,184,0.1)', marginBottom: 20 }}>
                                <div style={{ display: 'grid', gridTemplateColumns: 'repeat(3, 1fr)', gap: 15, marginBottom: 15 }}>
                                    <div className="form-group">
                                        <label style={{ fontSize: 10, color: '#9ca3af', textTransform: 'uppercase', marginBottom: 5, display: 'block', fontWeight: 600 }}>Eje Y Principal (Celeste)</label>
                                        <select 
                                            value={chartConfig.primaryY} 
                                            onChange={(e) => setChartConfig(prev => ({ ...prev, primaryY: e.target.value }))}
                                            style={{ width: '100%', padding: '8px', background: '#1e293b', color: '#38bdf8', border: '1px solid rgba(56, 189, 248, 0.2)', borderRadius: 6, fontSize: 12, fontWeight: 'bold' }}
                                        >
                                            {(CONFIG.dashboard.variables || []).map(v => <option key={v.key} value={v.key}>{v.label}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label style={{ fontSize: 10, color: '#9ca3af', textTransform: 'uppercase', marginBottom: 5, display: 'block', fontWeight: 600 }}>Eje Y Secundario (Lila)</label>
                                        <select 
                                            value={chartConfig.secondaryY} 
                                            onChange={(e) => setChartConfig(prev => ({ ...prev, secondaryY: e.target.value }))}
                                            style={{ width: '100%', padding: '8px', background: '#1e293b', color: '#a855f7', border: '1px solid rgba(168, 85, 247, 0.2)', borderRadius: 6, fontSize: 12, fontWeight: 'bold' }}
                                        >
                                            <option value="">(sin eje secundario)</option>
                                            {(CONFIG.dashboard.variables || []).map(v => <option key={v.key} value={v.key}>{v.label}</option>)}
                                        </select>
                                    </div>
                                    <div className="form-group">
                                        <label style={{ fontSize: 10, color: '#9ca3af', textTransform: 'uppercase', marginBottom: 5, display: 'block', fontWeight: 600 }}>Vista Horaria</label>
                                        <div style={{ display: 'flex', gap: 5 }}>
                                            {[
                                                { id: 'all', label: 'Todo', icon: 'ðŸŒ“' },
                                                { id: 'day', label: 'DÃ­a', icon: 'â˜€ï¸' },
                                                { id: 'night', label: 'Noche', icon: 'ðŸŒ™' }
                                            ].map(f => (
                                                <button
                                                    key={f.id}
                                                    disabled={chartConfig.timeRange === 'Ahora'}
                                                    onClick={() => setChartConfig(prev => ({ ...prev, filter: f.id }))}
                                                    style={{ 
                                                        flex: 1,
                                                        padding: '8px', 
                                                        borderRadius: 6, 
                                                        border: "1px solid " + (chartConfig.filter === f.id ? 'var(--adtec-accent)' : 'rgba(148,163,184,0.1)'),
                                                        background: chartConfig.filter === f.id ? 'rgba(56,189,248,0.1)' : '#1e293b',
                                                        color: chartConfig.filter === f.id ? 'var(--adtec-accent)' : '#9ca3af',
                                                        fontSize: 11,
                                                        cursor: 'pointer',
                                                        display: 'flex',
                                                        alignItems: 'center',
                                                        justifyContent: 'center',
                                                        gap: 4,
                                                        opacity: chartConfig.timeRange === 'Ahora' ? 0.5 : 1
                                                    }}
                                                >
                                                    {f.icon}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>

                                <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr 1.5fr', gap: 15 }}>
                                    <div className="form-group">
                                        <label style={{ fontSize: 10, color: '#9ca3af', textTransform: 'uppercase', marginBottom: 5, display: 'block', fontWeight: 600 }}>Desde</label>
                                        <input 
                                            type="datetime-local" 
                                            disabled={chartConfig.timeRange !== 'Rango'}
                                            value={chartConfig.fromDate || ''}
                                            onChange={(e) => setChartConfig(prev => ({ ...prev, fromDate: e.target.value }))}
                                            style={{ width: '100%', padding: '8px', background: '#1e293b', color: 'white', border: '1px solid rgba(148,163,184,0.2)', borderRadius: 6, fontSize: 11, opacity: chartConfig.timeRange !== 'Rango' ? 0.5 : 1 }}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label style={{ fontSize: 10, color: '#9ca3af', textTransform: 'uppercase', marginBottom: 5, display: 'block', fontWeight: 600 }}>Hasta</label>
                                        <input 
                                            type="datetime-local" 
                                            disabled={chartConfig.timeRange !== 'Rango'}
                                            value={chartConfig.toDate || ''}
                                            onChange={(e) => setChartConfig(prev => ({ ...prev, toDate: e.target.value }))}
                                            style={{ width: '100%', padding: '8px', background: '#1e293b', color: 'white', border: '1px solid rgba(148,163,184,0.2)', borderRadius: 6, fontSize: 11, opacity: chartConfig.timeRange !== 'Rango' ? 0.5 : 1 }}
                                        />
                                    </div>
                                    <div className="form-group">
                                        <label style={{ fontSize: 10, color: '#9ca3af', textTransform: 'uppercase', marginBottom: 5, display: 'block', fontWeight: 600 }}>Rango RÃ¡pido</label>
                                        <div style={{ display: 'flex', gap: 5 }}>
                                            {[
                                                { id: 'Ahora', label: 'LIVE' },
                                                { id: '24h', label: '24H' },
                                                { id: '7d', label: '7D' },
                                                { id: 'Rango', label: 'RANGO' }
                                            ].map(r => (
                                                <button
                                                    key={r.id}
                                                    onClick={() => setChartConfig(prev => ({ ...prev, timeRange: r.id }))}
                                                    style={{ 
                                                        flex: 1,
                                                        padding: '8px 4px', 
                                                        borderRadius: 6, 
                                                        border: "1px solid " + (chartConfig.timeRange === r.id ? 'var(--adtec-accent)' : 'rgba(148,163,184,0.1)'),
                                                        background: chartConfig.timeRange === r.id ? 'rgba(56,189,248,0.1)' : '#1e293b',
                                                        color: chartConfig.timeRange === r.id ? 'var(--adtec-accent)' : '#9ca3af',
                                                        fontSize: 10,
                                                        fontWeight: 700,
                                                        cursor: 'pointer'
                                                    }}
                                                >
                                                    {r.label}
                                                </button>
                                            ))}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div style={{ height: '400px', background: 'rgba(0,0,0,0.2)', borderRadius: 12, padding: 15 }}>
                                <DashboardChart 
                                    widget={{ label: activeVarLabel }} 
                                    dataHistory={displayData} 
                                    chartConfig={chartConfig}
                                />
                            </div>
                        </div>
                    ) : (
                        <div className="widgets-area">
                            {CONFIG.dashboard.widgets.filter(w => String(w.tabId) === String(activeTabId)).map(w => {
                            const valStr = getWidgetValue(w.key);
                            const val = parseFloat(valStr);
                            const style = { left: w.x, top: w.y, width: w.w, height: w.h, position: 'absolute' };

                            if (w.type === 'label') {
                                return (
                                    <div key={w.id} className="adtec-label-widget" style={{ ...style, color: w.color || 'white', fontSize: w.fontSize || 14, fontWeight: 'bold' }}>
                                        {w.label}
                                    </div>
                                );
                            }

                            if (w.type === 'chart' || w.type === 'summary-chart') {
                                return (
                                    <div key={w.id} className="adtec-status-item" style={style}>
                                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: 5, gap: 8 }}>
                                            <h3 style={{ flex: 1, wordBreak: 'break-word', lineHeight: '1.1' }}>{w.label}</h3>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 8, flexShrink: 0 }}>
                                                {!w.hideKey && <span style={{ fontSize: '9px', opacity: 0.4, color: '#9ca3af' }}>{w.key}</span>}
                                                <a href="/api/download/csv" title="Descargar CSV" style={{ color: '#94a3b8', textDecoration: 'none' }}>
                                                    <i data-lucide="download" style={{ width: 14, height: 14 }}></i>
                                                </a>
                                                <span style={{ fontSize: '14px', fontWeight: '800', color: 'var(--adtec-accent)' }}>{valStr}</span>
                                            </div>
                                        </div>
                                        <div style={{ flex: 1, position: 'relative', minHeight: 0 }}>
                                            <DashboardChart widget={w} dataHistory={[]} chartConfig={{ primaryY: w.key }} />
                                        </div>
                                    </div>
                                );
                            }

                            return (
                                <div key={w.id} className="adtec-status-item" style={style}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 8 }}>
                                            <h3 style={{ flex: 1, wordBreak: 'break-word', lineHeight: '1.1' }}>{w.label}</h3>
                                        {!w.hideKey && <span style={{ fontSize: '9px', opacity: 0.4, color: '#9ca3af', flexShrink: 0 }}>{w.key}</span>}
                                    </div>

                                    {w.type === 'gauge' && (() => {
                                        const numVal = isNaN(parseFloat(valStr)) ? (w.min || 0) : parseFloat(valStr);
                                        const min = w.min || 0;
                                        const max = w.max || 100;
                                        const pct = Math.max(0, Math.min(100, ((numVal - min) / (Math.max(1, max - min))) * 100));
                                        return (
                                            <>
                                                <div className="adtec-status-value" style={{ color: 'var(--adtec-accent)' }}>
                                                    {valStr.replace(w.unit || '', '')}
                                                    <span className="adtec-status-sub">{w.unit || ''}</span>
                                                </div>
                                                {(w.showBar ?? true) && (
                                                    <div className="adtec-temp-bar" style={{ background: getGradientByType('TEMP', 0.25, w.inverted) }}>
                                                        <div 
                                                            className="adtec-temp-bar-fill" 
                                                            style={{ 
                                                                width: pct + "%",
                                                                background: getGradientByType('TEMP', 1, w.inverted),
                                                                backgroundSize: (100 / (Math.max(1, pct) / 100)) + "% 100%",
                                                                boxShadow: "0 0 10px " + getGaugeColor(numVal, w.key) + "66"
                                                            }} 
                                                        />
                                                    </div>
                                                )}
                                            </>
                                        );
                                    })()}

                                    {w.type === 'indicator' && (() => {
                                        const isOn = valStr === 'ON' || valStr === 'ACTIVO' || valStr === 'TRUE';
                                        return (
                                            <div className={"adtec-status-chip " + (isOn ? "on" : "off")} style={{ marginTop: 'auto', alignSelf: 'flex-start' }}>
                                                <span className={"adtec-status-dot " + (isOn ? "on" : "off")} />
                                                <span>{isOn ? 'ACTIVO' : 'INACTIVO'}</span>
                                            </div>
                                        );
                                    })()}

                                    {w.type === 'control-relay' && (() => {
                                        const isOn = valStr === 'ON' || valStr === 'ACTIVO' || valStr === 'TRUE';
                                        const isManual = !!controlState.manual;
                                        return (
                                            <>
                                                <div className={"adtec-status-chip " + (isOn ? "on" : "off")} style={{ marginBottom: 10, alignSelf: 'flex-start' }}>
                                                    <span className={"adtec-status-dot " + (isOn ? "on" : "off")} />
                                                    <span>{isOn ? 'ACTIVO' : 'INACTIVO'}</span>
                                                </div>
                                                <div style={{ display: 'flex', gap: '5px' }}>
                                                    <button className="vfd-btn start" disabled={!isManual} style={{ background: isOn ? '#10b981' : undefined }} onClick={() => sendControl(w.target, true)}>ON</button>
                                                    <button className="vfd-btn stop" disabled={!isManual} style={{ background: !isOn ? '#ef4444' : undefined }} onClick={() => sendControl(w.target, false)}>OFF</button>
                                                </div>
                                            </>
                                        );
                                    })()}

                                    {w.type === 'control-vfd' && (() => {
                                        const freq = parseFloat(controlState[w.target] || 0);
                                        const isOn = valStr === 'ON' || valStr === 'ACTIVO' || valStr === 'TRUE';
                                        const isManual = !!controlState.manual;
                                        return (
                                            <div style={{ display: 'flex', flexDirection: 'column', gap: 15, marginTop: 5, alignItems: 'center', width: '100%' }}>
                                                <div className={"vfd-dial " + (isOn ? "on" : "")}>
                                                    <div className="vfd-dial-value">{freq.toFixed(1)}</div>
                                                    <div className="vfd-dial-unit">Hz</div>
                                                </div>
                                                <input 
                                                    type="range" min="0" max="60" step="0.5" 
                                                    value={freq}
                                                    disabled={!isManual}
                                                    style={{ width: '100%', accentColor: 'var(--adtec-accent)', opacity: isManual ? 1 : 0.5 }}
                                                    onChange={(e) => sendControl(w.target, parseFloat(e.target.value))}
                                                />
                                                <div style={{ display: 'flex', gap: '5px', width: '100%' }}>
                                                    <button className="vfd-btn start" disabled={!isManual} style={{ background: isOn ? '#10b981' : undefined }} onClick={() => sendControl(w.target + '_state', true)}>RUN</button>
                                                    <button className="vfd-btn stop" disabled={!isManual} style={{ background: !isOn ? '#ef4444' : undefined }} onClick={() => sendControl(w.target + '_state', false)}>STOP</button>
                                                </div>
                                            </div>
                                        );
                                    })()}

                                    {(w.type === 'text' || w.type === 'datetime' || w.type === 'connection') && (() => {
                                        const isGsmWidget = w.type === 'connection';
                                        
                                        if (isGsmWidget) {
                                            const sigKey = w.signalKey || w.key;
                                            const statKey = w.statusKey || w.key;
                                            
                                            const sigStr = getWidgetValue(sigKey);
                                            const statStr = getWidgetValue(statKey);

                                            const rawSig = parseInt(sigStr);
                                            const signal = (rawSig === 99 || isNaN(rawSig)) ? 0 : Math.ceil((rawSig / 31) * 5);
                                            
                                            const explicitStatus = (statStr === 'ONLINE' || statStr === 'BUSCANDO' || statStr === 'OFFLINE') ? statStr : null;
                                            const isOnline = connStatus === 'ONLINE';

                                            return (
                                                <div style={{ display: 'flex', flexDirection: 'column', gap: 8, marginTop: 5 }}>
                                                    <div className="gsm-bars" style={{ height: 25, display: 'flex', gap: 3, alignItems: 'flex-end' }}>
                                                        {[1, 2, 3, 4, 5].map(bar => (
                                                            <div key={bar} style={{ 
                                                                width: 6, 
                                                                height: bar * 20 + '%', 
                                                                background: bar <= signal ? 'var(--adtec-accent)' : 'rgba(255,255,255,0.1)',
                                                                borderRadius: '2px',
                                                                boxShadow: bar <= signal ? '0 0 10px var(--adtec-accent)' : 'none'
                                                            }} />
                                                        ))}
                                                    </div>
                                                    <div className={"adtec-status-chip " + (explicitStatus ? (explicitStatus === 'ONLINE' ? 'on' : (explicitStatus === 'BUSCANDO' ? 'warn' : 'off')) : (isOnline ? (rawSig === 99 ? "warn" : "on") : "off"))} style={{ alignSelf: 'flex-start' }}>
                                                        <span className={"adtec-status-dot " + (explicitStatus ? (explicitStatus === 'ONLINE' ? 'on' : (explicitStatus === 'BUSCANDO' ? 'warn' : 'off')) : (isOnline ? (rawSig === 99 ? "warn" : "on") : "off"))} />
                                                        <span>{explicitStatus || (isOnline ? (rawSig === 99 ? 'BUSCANDO...' : 'CONECTADO') : 'DESCONECTADO')}</span>
                                                    </div>
                                                </div>
                                            );
                                        }
                                        if (w.label.toLowerCase().includes('red') || w.label.toLowerCase().includes('estado')) {
                                            const isOnline = connStatus === 'ONLINE';
                                            return (
                                                <div className={"adtec-status-chip " + (isOnline ? "on" : "off")} style={{ marginTop: 'auto', alignSelf: 'flex-start' }}>
                                                    <span className={"adtec-status-dot " + (isOnline ? "on" : "off")} />
                                                    <span>{isOnline ? 'ONLINE' : 'OFFLINE'}</span>
                                                </div>
                                            );
                                        }

                                        if (w.type === 'datetime') {
                                            const isTelemetriaValue = valStr !== '--' && valStr.includes(':');
                                            const displayTime = isTelemetriaValue ? valStr : new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
                                            const displayDate = isTelemetriaValue ? '' : new Date().toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                                            return (
                                                <div style={{ display: 'flex', alignItems: 'center', gap: 10, marginTop: 5 }}>
                                                    <span style={{ fontSize: 20 }}>â°</span>
                                                    <div>
                                                        <div style={{ fontSize: 14, color: 'var(--adtec-accent)', fontWeight: 800 }}>{displayTime}</div>
                                                        {displayDate && <div style={{ fontSize: 10, color: '#9ca3af' }}>{displayDate}</div>}
                                                    </div>
                                                </div>
                                            );
                                        }

                                        return (
                                            <div className="adtec-status-value" style={{ color: 'var(--adtec-accent)' }}>
                                                {valStr.replace(w.unit || '', '')}
                                                <span className="adtec-status-sub">{w.unit || ''}</span>
                                            </div>
                                        );
                                    })()}

                                    {w.type === 'location' && (() => {
                                        const displayCity = lastValidLocation.city !== '--' ? lastValidLocation.city : 'UbicaciÃ³n Pro';
                                        const displayCoords = lastValidLocation.coord !== '--' ? "Coordenadas: " + lastValidLocation.coord : 'Detectando GPS...';
                                        return (
                                            <div style={{ display: 'flex', alignItems: 'center', gap: 8, marginTop: 5, color: '#9ca3af' }}>
                                                <span style={{ fontSize: 20 }}>ðŸ“</span>
                                                <div>
                                                    <div style={{ fontSize: 12, color: 'white', fontWeight: 600 }}>{displayCity}</div>
                                                    <div style={{ fontSize: 10, opacity: 0.6 }}>{displayCoords}</div>
                                                </div>
                                            </div>
                                        );
                                    })()}
                                </div>
                            );
                        })}
                        </div>
                    )}
                </div>
            </div>
        </div>
    );
};

ReactDOM.render(<DashboardApp />, document.getElementById('dashboard-root'));

        
        // Inicializar iconos despuÃ©s de que React termine
        setTimeout(() => { if(window.lucide) lucide.createIcons(); }, 500);
    </script>
</body>
</html>